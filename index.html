<script>
    safari.application.addEventListener('command', openInSourcegraph, false)

    function openInSourcegraph(event) {
        if (event.command != 'open') {
            return
        }
        var url = event.target.browserWindow.activeTab.url
        var repository = new Repository(url)
        if (!repository.isAvailableOnSourcegraph()) {
            return
        }
        event.target.browserWindow.activeTab.url = repository.sourcegraphURL()
    }

    function Repository(url) {
        this.parseURL(url)
    }

    Repository.prototype.parseURL = function (url) {
        var parts = url.split('/')
        this.host = parts[2]
        this.author = parts[3]
        this.name = parts[4]
        var paths = parts.slice(5)
        this.branch = paths.splice(1, 1)[0]
        this.path = paths.join('/')
    }

    var availableHosts = [
        'github.com'
    ]

    Repository.prototype.isAvailableOnSourcegraph = function () {
        return availableHosts.includes(this.host)
    }

    Repository.prototype.sourcegraphURL = function () {
        var url = 'https://sourcegraph.com'
        return url + '/' + this.host + '/' + this.author + '/' + this.name + '@' + this.branch + '/-/' + this.path
    }
</script>