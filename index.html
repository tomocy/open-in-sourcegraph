<script>
    safari.application.addEventListener('command', openInSourcegraph, false)

    function openInSourcegraph(event) {
        if (event.command != 'open') {
            return
        }
        const url = event.target.browserWindow.activeTab.url
        const repository = new Repository(url)
        if (!repository.isAvailableOnSourcegraph()) {
            return
        }
        event.target.browserWindow.activeTab.url = repository.sourcegraphURL()
    }

    function Repository(url) {
        this.parseURL(url)
    }

    Repository.prototype.parseURL = function (url) {
        const parts = url.split('/')
        this.host = parts[2]
        this.author = parts[3]
        this.name = parts[4]
        const paths = parts.slice(5)
        const branchContainer = paths.splice(1, 1)
        this.branch = branchContainer.length === 1 ? branchContainer[0] : ""
        this.path = paths.join('/')
    }

    const availableHosts = [
        'github.com'
    ]

    Repository.prototype.isAvailableOnSourcegraph = function () {
        return availableHosts.includes(this.host)
    }

    Repository.prototype.sourcegraphURL = function () {
        const sourcegraph = 'https://sourcegraph.com'
        let dst = `${sourcegraph}/${this.host}/${this.author}/${this.name}`
        if (this.branch !== "") {
            dst += `@${this.branch}`
        }
        if (this.path !== "") {
            dst += `/-/${this.path}`
        }
        return dst
    }
</script>